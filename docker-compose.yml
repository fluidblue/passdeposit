version: "3.8"

services:
    passdeposit:
        image: node:14
        command: sh "/var/passdeposit/scripts/init-passdeposit.sh"
        ports:
            - 8000:8000
        depends_on:
            - mongodb
        volumes:
            - ./install/config:/etc/passdeposit
            - ./install/scripts:/var/passdeposit/scripts

    mongodb:
        image: mongo:3.6.9
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: admin
            MONGO_INITDB_ROOT_PASSWORD_FILE: /etc/passdeposit/mongodb_initial_admin_password.txt
            MONGO_INITDB_DATABASE: passdeposit
        ports:
            - 127.0.0.1:27017:27017
        volumes:
            - ./install/config:/etc/passdeposit
            - ./install/config/mongodb-init-scripts/:/docker-entrypoint-initdb.d
            - mongodb-data:/data/db
            - mongodb-config:/data/configdb

    mongodb-backup:
        image: ubuntu:16.04
        command: sh "/var/passdeposit/scripts/init-mongodb-backup.sh"
        volumes:
            - ./install/scripts:/var/passdeposit/scripts
            - ./install/config:/etc/passdeposit
            - ./install/backup:/var/passdeposit/backup

volumes:
    mongodb-data:
    mongodb-config:
